<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Singapore PSI Data Dashboard</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #667eea;
      --primary-dark: #5a6fd8;
      --secondary: #764ba2;
      --accent: #f093fb;
      --text: #333;
      --text-light: #666;
      --bg: #f8f9fa;
      --card: white;
      --good: #5bc0de;
      --moderate: #a3b1ff;
      --unhealthy: #9d7bd1;
      --very-unhealthy: #764ba2;
      --hazardous: #5a3d7a;
      --border-radius: 12px;
      --card-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      min-height: 100vh;
      padding: 20px;
      color: var(--text);
      transition: all 0.3s ease;
      line-height: 1.5;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
      color: white;
      position: relative;
    }

    .header h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
      font-weight: 700;
      letter-spacing: -0.5px;
    }

    .header p {
      font-size: 1.1rem;
      opacity: 0.9;
      font-weight: 300;
    }

    .theme-toggle {
      position: absolute;
      top: 0;
      right: 0;
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      padding: 8px 12px;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.9rem;
    }

    .theme-toggle:hover {
      background: rgba(255,255,255,0.3);
    }

    .card {
      background: var(--card);
      border-radius: var(--border-radius);
      padding: 30px;
      box-shadow: var(--card-shadow);
      margin-bottom: 25px;
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
    }

    .time-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 15px;
    }

    .time-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 1rem;
      color: var(--text-light);
      padding: 10px 15px;
      background: var(--bg);
      border-radius: 8px;
      transition: all 0.3s ease;
      font-weight: 400;
    }

    .time-item i {
      color: var(--primary);
    }

    .controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 15px;
    }

    .search-box {
      padding: 10px 15px;
      border: 1px solid #e0e0e0;
      border-radius: 10px;
      font-size: 1rem;
      width: 250px;
      transition: all 0.3s ease;
      background: var(--card);
      font-family: inherit;
    }

    .search-box:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .refresh-btn {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 1rem;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 500;
    }

    .refresh-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .refresh-btn:active {
      transform: translateY(0);
    }

    .refresh-btn.loading i {
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    .table-container {
      overflow-x: auto;
      border-radius: var(--border-radius);
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      background: var(--card);
      border-radius: var(--border-radius);
      overflow: hidden;
    }

    th {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      padding: 16px;
      text-align: center; /* Ë°®Â§¥Â±Ö‰∏≠ */
      font-weight: 600;
      position: sticky;
      top: 0;
      font-size: 0.95rem;
    }

    /* Á¨¨‰∏ÄÂàóÔºàÊåáÊ†áÂêçÁß∞Ôºâ‰øùÊåÅÂ∑¶ÂØπÈΩê */
    th:first-child {
      text-align: left;
    }

    td {
      padding: 16px;
      border-bottom: 1px solid rgba(0,0,0,0.05);
      transition: all 0.2s ease;
      text-align: center; /* ÊâÄÊúâÊï∞ÊçÆÂçïÂÖÉÊ†ºÂ±Ö‰∏≠ */
    }

    /* Á¨¨‰∏ÄÂàóÔºàÊåáÊ†áÂêçÁß∞Ôºâ‰øùÊåÅÂ∑¶ÂØπÈΩê */
    td:first-child {
      text-align: left;
    }

    /* ÂçïÂÖÉÊ†ºÊÇ¨ÂÅúÊïàÊûú */
    td:hover {
      background-color: rgba(227, 232, 255, 0.5) !important;
      position: relative;
      z-index: 1;
    }

    .metric-name {
      font-weight: 600;
      color: var(--text);
      font-size: 0.95rem;
    }

    /* ‰ªøËãπÊûúÈ£éÊ†ºÁöÑÊï∞ÂÄºÊòæÁ§∫Ê†∑Âºè */
    .psi-value {
      text-align: center;
      font-weight: 600;
      padding: 8px 12px;
      margin: 0 auto; /* Á°Æ‰øùÂ±Ö‰∏≠ */
      border-radius: 8px;
      transition: all 0.3s ease;
      display: inline-block;
      min-width: 50px;
      font-size: 0.9rem;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      border: 1px solid rgba(0,0,0,0.03);
    }

    .psi-value:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .loading-container {
      text-align: center;
      padding: 40px;
    }

    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 2s linear infinite;
      margin: 0 auto 20px;
    }

    .data-source {
      text-align: center;
      padding: 20px;
      color: white;
      margin-top: 20px;
    }

    .data-source a {
      color: #fff;
      text-decoration: none;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .data-source a:hover {
      text-decoration: underline;
      text-shadow: 0 0 10px rgba(255,255,255,0.5);
    }

    .filters {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .filter-btn {
      padding: 8px 16px;
      border: 1px solid #e0e0e0;
      background: var(--card);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.9rem;
      font-weight: 500;
    }

    .filter-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    /* Êõ¥Êñ∞È¢úËâ≤ÊñπÊ°à - Êõ¥ÂíåË∞êÁöÑËìùËâ≤/Á¥´Ëâ≤Ë∞É */
    .psi-good { 
      background: linear-gradient(135deg, #5bc0de, #4cadc9);
      color: white; 
      box-shadow: 0 2px 5px rgba(91, 192, 222, 0.3);
    }
    .psi-moderate { 
      background: linear-gradient(135deg, #a3b1ff, #8f9ef5);
      color: white; 
      box-shadow: 0 2px 5px rgba(163, 177, 255, 0.3);
    }
    .psi-unhealthy { 
      background: linear-gradient(135deg, #9d7bd1, #8b6ac0);
      color: white; 
      box-shadow: 0 2px 5px rgba(157, 123, 209, 0.3);
    }
    .psi-very-unhealthy { 
      background: linear-gradient(135deg, #764ba2, #684392);
      color: white; 
      box-shadow: 0 2px 5px rgba(118, 75, 162, 0.3);
    }
    .psi-hazardous { 
      background: linear-gradient(135deg, #5a3d7a, #4d3568);
      color: white; 
      box-shadow: 0 2px 5px rgba(90, 61, 122, 0.3);
    }

    /* Êñ∞Â¢ûÂäüËÉΩÊ†∑Âºè */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: var(--card);
      padding: 20px;
      border-radius: var(--border-radius);
      text-align: center;
      box-shadow: var(--card-shadow);
      transition: all 0.3s ease;
      border: 1px solid rgba(0,0,0,0.03);
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    }

    .stat-value {
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--primary);
      margin: 5px 0;
      letter-spacing: -0.5px;
    }

    .stat-label {
      font-size: 0.9rem;
      color: var(--text-light);
      font-weight: 500;
    }

    .highlight-updated {
      animation: highlight 1.5s ease;
    }

    @keyframes highlight {
      0% { background-color: rgba(255, 255, 0, 0.3); }
      100% { background-color: transparent; }
    }

    .psi-explanation {
      margin-top: 20px;
      padding: 20px;
      background: var(--bg);
      border-radius: var(--border-radius);
      font-size: 0.9rem;
      border: 1px solid rgba(0,0,0,0.05);
    }

    .psi-levels {
      display: flex;
      justify-content: space-between;
      margin-top: 10px;
    }

    .psi-level {
      text-align: center;
      flex: 1;
      padding: 5px;
      font-size: 0.8rem;
    }

    .psi-color {
      width: 100%;
      height: 10px;
      margin-bottom: 5px;
      border-radius: 5px;
    }

    .dark-mode {
      --text: #f0f0f0;
      --text-light: #b0b0b0;
      --bg: #2d3748;
      --card: #4a5568;
    }

    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }
      
      .card {
        padding: 20px;
      }
      
      .time-info {
        flex-direction: column;
        align-items: stretch;
      }
      
      .controls {
        flex-direction: column;
        align-items: stretch;
      }
      
      .search-box {
        width: 100%;
      }
      
      th, td {
        padding: 12px;
        font-size: 0.9rem;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }
      
      .psi-levels {
        flex-direction: column;
        gap: 10px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üå§Ô∏è Singapore PSI Dashboard</h1>
      <p>Real-time Air Quality Monitoring</p>
      <button class="theme-toggle" id="themeToggle">
        <i class="fas fa-moon"></i> Dark Mode
      </button>
    </div>

    <div class="card">
      <div class="time-info">
        <div class="time-item">
          <i class="fas fa-database"></i>
          <span id="dataUpdateTime">Data updated: Loading...</span>
        </div>
        <div class="time-item">
          <i class="fas fa-clock"></i>
          <span id="lastRefreshTime">Last refreshed: Never</span>
        </div>
      </div>

      <div class="stats-grid" id="statsGrid">
        <!-- ÁªüËÆ°Êï∞ÊçÆÂ∞ÜÂä®ÊÄÅÂ°´ÂÖÖ -->
      </div>

      <div class="controls">
        <div class="filters">
          <button class="filter-btn active" data-filter="all">All Metrics</button>
          <button class="filter-btn" data-filter="pm">PM2.5/PM10</button>
          <button class="filter-btn" data-filter="o3">Ozone</button>
          <button class="filter-btn" data-filter="so2">SO‚ÇÇ</button>
        </div>
        
        <input type="text" class="search-box" placeholder="Search metrics..." id="searchInput">
        
        <button class="refresh-btn" id="refreshBtn">
          <i class="fas fa-sync-alt"></i>
          Refresh Data
        </button>
      </div>

      <div class="table-container">
        <table id="PSItable">
          <thead>
            <tr>
              <th>Metric</th>
              <th>Central</th>
              <th>West</th>
              <th>East</th>
              <th>North</th>
              <th>South</th>
            </tr>
          </thead>
          <tbody id="tableBody">
            <!-- Data will be populated here -->
          </tbody>
        </table>
      </div>

      <div class="psi-explanation">
        <h3>PSI Levels Guide</h3>
        <div class="psi-levels">
          <div class="psi-level">
            <div class="psi-color" style="background: linear-gradient(135deg, #5bc0de, #4cadc9);"></div>
            <div>Good (0-50)</div>
          </div>
          <div class="psi-level">
            <div class="psi-color" style="background: linear-gradient(135deg, #a3b1ff, #8f9ef5);"></div>
            <div>Moderate (51-100)</div>
          </div>
          <div class="psi-level">
            <div class="psi-color" style="background: linear-gradient(135deg, #9d7bd1, #8b6ac0);"></div>
            <div>Unhealthy (101-200)</div>
          </div>
          <div class="psi-level">
            <div class="psi-color" style="background: linear-gradient(135deg, #764ba2, #684392);"></div>
            <div>Very Unhealthy (201-300)</div>
          </div>
          <div class="psi-level">
            <div class="psi-color" style="background: linear-gradient(135deg, #5a3d7a, #4d3568);"></div>
            <div>Hazardous (>300)</div>
          </div>
        </div>
      </div>

      <div class="loading-container" id="loadingIndicator">
        <div class="spinner"></div>
        <p>Loading PSI data...</p>
      </div>
    </div>

    <div class="data-source">
      <p>
        Data Source: 
        <a href="https://data.gov.sg/dataset/psi" target="_blank" rel="noopener noreferrer">
          data.gov.sg - PSI API
        </a>
        ‚Ä¢ 
        <a href="https://api.data.gov.sg/v1/environment/psi" target="_blank" rel="noopener noreferrer">
          View Raw API Data
        </a>
      </p>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.9.0/d3.min.js"></script>
  <script>
    let currentData = null;

    // Ëé∑ÂèñDOMÂÖÉÁ¥†
    const tableBody = document.getElementById('tableBody');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const refreshBtn = document.getElementById('refreshBtn');
    const searchInput = document.getElementById('searchInput');
    const filterBtns = document.querySelectorAll('.filter-btn');
    const dataUpdateTimeElement = document.getElementById('dataUpdateTime');
    const lastRefreshTimeElement = document.getElementById('lastRefreshTime');
    const statsGrid = document.getElementById('statsGrid');
    const themeToggle = document.getElementById('themeToggle');

    // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
    function showLoading() {
      loadingIndicator.style.display = 'block';
      tableBody.innerHTML = '';
    }

    // ÈöêËóèÂä†ËΩΩÁä∂ÊÄÅ
    function hideLoading() {
      loadingIndicator.style.display = 'none';
    }

    // Ê†πÊçÆPSIÂÄºËé∑ÂèñÈ¢úËâ≤Á±ªÂà´
    function getPSIColor(value) {
      if (value <= 50) return 'psi-good';
      if (value <= 100) return 'psi-moderate';
      if (value <= 200) return 'psi-unhealthy';
      if (value <= 300) return 'psi-very-unhealthy';
      return 'psi-hazardous';
    }

    // Ëé∑ÂèñÂå∫ÂüüÁöÑÂπ≥ÂùáPSI
    function getRegionAveragePSI(readings, region) {
      const values = Object.keys(readings)
        .filter(metric => metric.includes('psi'))
        .map(metric => readings[metric][region])
        .filter(value => value !== null && !isNaN(value));
      
      return values.length > 0 ? 
        Math.round(values.reduce((a, b) => a + b, 0) / values.length) : 
        null;
    }

    // Ê∏≤ÊüìÁªüËÆ°Êï∞ÊçÆ
    function renderStats(data) {
      statsGrid.innerHTML = '';
      const readings = data.items[0].readings;
      const regions = ["central", "west", "east", "north", "south"];
      
      regions.forEach(region => {
        const avgPSI = getRegionAveragePSI(readings, region);
        if (avgPSI !== null) {
          const statCard = document.createElement('div');
          statCard.className = 'stat-card';
          
          const psiLevel = getPSIColor(avgPSI).replace('psi-', '');
          const levelNames = {
            'good': 'Good',
            'moderate': 'Moderate',
            'unhealthy': 'Unhealthy',
            'very-unhealthy': 'Very Unhealthy',
            'hazardous': 'Hazardous'
          };
          
          statCard.innerHTML = `
            <div class="stat-label">${region.charAt(0).toUpperCase() + region.slice(1)}</div>
            <div class="stat-value">${avgPSI}</div>
            <div class="psi-level">${levelNames[psiLevel]}</div>
          `;
          
          statsGrid.appendChild(statCard);
        }
      });
    }

    // Ê∏≤ÊüìË°®Ê†ºÊï∞ÊçÆ
    function renderTable(data, searchTerm = '', filter = 'all') {
      tableBody.innerHTML = '';
      const readings = data.items[0].readings;

      Object.keys(readings).forEach(metric => {
        // ÊêúÁ¥¢ËøáÊª§
        if (searchTerm && !metric.toLowerCase().includes(searchTerm.toLowerCase())) {
          return;
        }

        // ÂàÜÁ±ªËøáÊª§
        if (filter !== 'all') {
          if (filter === 'pm' && !metric.includes('pm')) return;
          if (filter === 'o3' && !metric.includes('o3')) return;
          if (filter === 'so2' && !metric.includes('so2')) return;
        }

        const row = document.createElement('tr');
        
        // ÊåáÊ†áÂêçÁß∞ÂçïÂÖÉÊ†º
        const metricCell = document.createElement('td');
        metricCell.className = 'metric-name';
        metricCell.textContent = metric;
        row.appendChild(metricCell);

        // Âå∫ÂüüÊï∞ÊçÆÂçïÂÖÉÊ†º
        ["central", "west", "east", "north", "south"].forEach(region => {
          const cell = document.createElement('td');
          const value = readings[metric][region];
          
          // ‰∏∫Êï∞ÂÄºÊ∑ªÂä†È´òÁ∫ßÊ†∑Âºè
          if (!isNaN(value) && value !== null) {
            const valueSpan = document.createElement('span');
            valueSpan.className = `psi-value ${getPSIColor(value)}`;
            valueSpan.textContent = value;
            cell.appendChild(valueSpan);
          } else {
            cell.textContent = value;
          }
          
          row.appendChild(cell);
        });

        tableBody.appendChild(row);
      });
    }

    // ‰ªé data.gov.sg Ëé∑ÂèñÂÆûÊó∂ PSI Êï∞ÊçÆ
    function fetchPSIData() {
      showLoading();
      refreshBtn.classList.add('loading');

      // Ê∑ªÂä†ÈöèÊú∫ÂèÇÊï∞Èò≤Ê≠¢ÁºìÂ≠ò
      const timestamp = new Date().getTime();
      fetch(`https://api.data.gov.sg/v1/environment/psi?_=${timestamp}`)
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          console.log("Fresh data fetched:", data);
          currentData = data;

          // Ëé∑ÂèñÂΩìÂâçÊó∂Èó¥‰Ωú‰∏∫Âà∑Êñ∞Êó∂Èó¥
          const refreshTime = new Date();
          lastRefreshTimeElement.textContent = `Last refreshed: ${refreshTime.toLocaleString()}`;

          // ÊòæÁ§∫APIÊï∞ÊçÆ‰∏≠ÁöÑÊõ¥Êñ∞Êó∂Èó¥
          const updateTime = new Date(data.items[0].update_timestamp);
          dataUpdateTimeElement.textContent = `Data updated: ${updateTime.toLocaleString()}`;

          // Ê∏≤ÊüìÁªüËÆ°Êï∞ÊçÆÂíåË°®Ê†º
          renderStats(data);
          renderTable(data);
          hideLoading();
          refreshBtn.classList.remove('loading');
          
          // Ê∑ªÂä†Êõ¥Êñ∞Âä®Áîª
          document.querySelectorAll('.psi-value').forEach(cell => {
            cell.classList.add('highlight-updated');
            setTimeout(() => {
              cell.classList.remove('highlight-updated');
            }, 1500);
          });
        })
        .catch(error => {
          console.error("Error fetching PSI data:", error);
          dataUpdateTimeElement.textContent = "Failed to load data. Please try again.";
          hideLoading();
          refreshBtn.classList.remove('loading');
        });
    }

    // ÂàáÊç¢‰∏ªÈ¢ò
    function toggleTheme() {
      document.body.classList.toggle('dark-mode');
      if (document.body.classList.contains('dark-mode')) {
        themeToggle.innerHTML = '<i class="fas fa-sun"></i> Light Mode';
      } else {
        themeToggle.innerHTML = '<i class="fas fa-moon"></i> Dark Mode';
      }
    }

    // ‰∫ã‰ª∂ÁõëÂê¨Âô®
    refreshBtn.addEventListener('click', fetchPSIData);
    themeToggle.addEventListener('click', toggleTheme);

    searchInput.addEventListener('input', (e) => {
      if (currentData) {
        renderTable(currentData, e.target.value, document.querySelector('.filter-btn.active').dataset.filter);
      }
    });

    filterBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        filterBtns.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        if (currentData) {
          renderTable(currentData, searchInput.value, btn.dataset.filter);
        }
      });
    });

    // ÂàùÂßãÂä†ËΩΩ
    fetchPSIData();

    // Ëá™Âä®Âà∑Êñ∞ÔºàÊØè2ÂàÜÈíüÔºâ
    setInterval(fetchPSIData, 2 * 60 * 1000);
  </script>
</body>
</html>
